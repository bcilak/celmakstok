{% extends "base.html" %}

{% block title %}Stok Ã‡Ä±kÄ±ÅŸÄ± - Ã‡ELMAK Stok Takip{% endblock %}

{% block content %}
<div class="page-header">
    <h1 class="page-title">Stok Ã‡Ä±kÄ±ÅŸÄ±</h1>
    <p class="page-subtitle">Depodan malzeme Ã§Ä±kÄ±ÅŸÄ± kaydedin</p>
</div>

<div class="row">
    <div class="col-lg-8">
        <div class="card">
            <div class="card-body">
                <form method="POST">
                    <div class="row g-3">
                        <div class="col-12">
                            <label class="form-label">ÃœrÃ¼n *</label>
                            <div class="position-relative">
                                <input type="text" class="form-control mb-2" id="productSearch"
                                    placeholder="ðŸ” ÃœrÃ¼n ara... (kod veya isim yazÄ±n)" autocomplete="off">
                                <select name="product_id" class="form-select" id="productSelect" required size="8"
                                    style="display:none;">
                                    <option value="">ÃœrÃ¼n SeÃ§in</option>
                                    {% for p in products %}
                                    <option value="{{ p.id }}" data-unit="{{ p.unit_type }}"
                                        data-stock="{{ p.current_stock }}" data-code="{{ p.code }}"
                                        data-name="{{ p.name }}">
                                        {{ p.code }} - {{ p.name }} (Mevcut: {{ p.current_stock }} {{ p.unit_type }})
                                    </option>
                                    {% endfor %}
                                </select>
                                <div id="searchResults" class="list-group position-absolute w-100"
                                    style="z-index:1000; max-height:300px; overflow-y:auto; display:none; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
                                </div>
                            </div>
                            <div id="selectedProduct" class="alert alert-warning mt-2" style="display:none;">
                                <strong id="selectedProductName"></strong>
                                <button type="button" class="btn-close float-end" onclick="clearSelection()"></button>
                            </div>
                        </div>

                        <div class="col-md-6">
                            <label class="form-label">Ã‡Ä±kÄ±ÅŸ MiktarÄ± *</label>
                            <div class="input-group">
                                <input type="number" name="quantity" class="form-control" id="quantityInput" step="0.01"
                                    min="0.01" required>
                                <span class="input-group-text" id="unitDisplay">birim</span>
                            </div>
                            <div class="form-text text-danger" id="stockWarning" style="display: none;">
                                Yetersiz stok!
                            </div>
                        </div>

                        <div class="col-md-6">
                            <label class="form-label">Ã‡Ä±kÄ±ÅŸ TÃ¼rÃ¼ *</label>
                            <select name="movement_type" class="form-select" required>
                                {% for type_code, type_name in movement_types %}
                                <option value="{{ type_code }}">{{ type_name }}</option>
                                {% endfor %}
                            </select>
                        </div>

                        <div class="col-md-6">
                            <label class="form-label">Ãœretim HattÄ±</label>
                            <select name="category_id" class="form-select">
                                <option value="">SeÃ§in (opsiyonel)</option>
                                {% for c in categories %}
                                <option value="{{ c.id }}">{{ c.name }}</option>
                                {% endfor %}
                            </select>
                        </div>

                        <div class="col-md-6">
                            <label class="form-label">Referans No</label>
                            <input type="text" name="reference_no" class="form-control" placeholder="Ä°ÅŸ emri/Talep no">
                        </div>

                        <div class="col-12">
                            <label class="form-label">Notlar</label>
                            <textarea name="notes" class="form-control" rows="2"
                                placeholder="Ek bilgiler..."></textarea>
                        </div>
                    </div>

                    <hr class="my-4">

                    <div class="d-flex gap-2">
                        <button type="submit" class="btn btn-danger" id="submitBtn">
                            <i class="bi bi-dash-lg me-2"></i>Ã‡Ä±kÄ±ÅŸ Kaydet
                        </button>
                        <a href="{{ url_for('stock.index') }}" class="btn btn-outline-secondary">Ä°ptal</a>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div class="col-lg-4">
        <div class="card bg-danger bg-opacity-10">
            <div class="card-body">
                <h6 class="card-title text-danger"><i class="bi bi-arrow-up-circle me-2"></i>Stok Ã‡Ä±kÄ±ÅŸÄ± HakkÄ±nda</h6>
                <ul class="small mb-0">
                    <li><strong>Ãœretimde KullanÄ±m:</strong> Ãœretim iÃ§in tÃ¼ketilen malzeme</li>
                    <li><strong>Hatlara Sevk:</strong> Ãœretim hattÄ±na gÃ¶nderilen malzeme</li>
                    <li><strong>Fire:</strong> Zayi olan veya kullanÄ±lamaz malzeme</li>
                    <li><strong>Transfer:</strong> BaÅŸka depoya transfer</li>
                </ul>
            </div>
        </div>

        <div class="card mt-3" id="productInfo" style="display: none;">
            <div class="card-body">
                <h6 class="card-title">SeÃ§ili ÃœrÃ¼n</h6>
                <div class="text-center py-3">
                    <div class="display-6 fw-bold" id="currentStock">0</div>
                    <small class="text-muted">Mevcut Stok</small>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    let currentStock = 0;
    const productSelect = document.getElementById('productSelect');
    const searchInput = document.getElementById('productSearch');
    const searchResults = document.getElementById('searchResults');
    const selectedProductDiv = document.getElementById('selectedProduct');
    const selectedProductName = document.getElementById('selectedProductName');

    // TÃ¼m Ã¼rÃ¼n seÃ§eneklerini diziye al
    const allProducts = [];
    for (let option of productSelect.options) {
        if (option.value) {
            allProducts.push({
                id: option.value,
                code: option.dataset.code || '',
                name: option.dataset.name || '',
                unit: option.dataset.unit || 'birim',
                stock: parseFloat(option.dataset.stock) || 0,
                text: option.textContent
            });
        }
    }

    // Arama fonksiyonu
    searchInput.addEventListener('input', function () {
        const query = this.value.toLowerCase().trim();

        if (query.length < 2) {
            searchResults.style.display = 'none';
            return;
        }

        const filtered = allProducts.filter(p =>
            p.code.toLowerCase().includes(query) ||
            p.name.toLowerCase().includes(query)
        ).slice(0, 20);

        if (filtered.length === 0) {
            searchResults.innerHTML = '<div class="list-group-item text-muted">SonuÃ§ bulunamadÄ±</div>';
        } else {
            searchResults.innerHTML = filtered.map(p => {
                const stockClass = p.stock <= 0 ? 'bg-danger' : 'bg-success';
                return `
                <button type="button" class="list-group-item list-group-item-action ${p.stock <= 0 ? 'list-group-item-danger' : ''}" 
                    onclick="selectProduct('${p.id}', '${p.code}', '${p.name.replace(/'/g, "\\'")}', '${p.unit}', ${p.stock})">
                    <strong>${p.code}</strong> - ${p.name}
                    <span class="badge ${stockClass} float-end">${p.stock} ${p.unit}</span>
                </button>
            `;
            }).join('');
        }
        searchResults.style.display = 'block';
    });

    // ÃœrÃ¼n seÃ§me
    function selectProduct(id, code, name, unit, stock) {
        productSelect.value = id;
        currentStock = stock;
        searchInput.value = '';
        searchResults.style.display = 'none';

        selectedProductName.textContent = code + ' - ' + name + ' (Stok: ' + stock + ' ' + unit + ')';
        selectedProductDiv.style.display = 'block';

        document.getElementById('unitDisplay').textContent = unit;
        document.getElementById('currentStock').textContent = stock + ' ' + unit;
        document.getElementById('productInfo').style.display = 'block';

        checkStock();
    }

    // SeÃ§imi temizle
    function clearSelection() {
        productSelect.value = '';
        currentStock = 0;
        selectedProductDiv.style.display = 'none';
        document.getElementById('productInfo').style.display = 'none';
        searchInput.focus();
    }

    // DÄ±ÅŸarÄ± tÄ±klayÄ±nca sonuÃ§larÄ± kapat
    document.addEventListener('click', function (e) {
        if (!searchInput.contains(e.target) && !searchResults.contains(e.target)) {
            searchResults.style.display = 'none';
        }
    });

    document.getElementById('quantityInput').addEventListener('input', checkStock);

    function checkStock() {
        const qty = parseFloat(document.getElementById('quantityInput').value) || 0;
        const warning = document.getElementById('stockWarning');
        const btn = document.getElementById('submitBtn');

        if (qty > currentStock && currentStock > 0) {
            warning.style.display = 'block';
            btn.disabled = true;
        } else {
            warning.style.display = 'none';
            btn.disabled = false;
        }
    }

    // Sayfa yÃ¼klendiÄŸinde seÃ§ili Ã¼rÃ¼n varsa gÃ¶ster
    {% if selected_product %}
    document.addEventListener('DOMContentLoaded', function () {
        selectProduct(
            '{{ selected_product.id }}',
            '{{ selected_product.code }}',
            '{{ selected_product.name|replace("'", "\\'")|safe }}',
            '{{ selected_product.unit_type }}',
            {{ selected_product.current_stock }}
    );
    });
    {% endif %}
</script>
{% endblock %}