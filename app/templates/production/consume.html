{% extends "base.html" %}

{% block title %}Malzeme T√ºketimi - {{ category.name }}{% endblock %}

{% block content %}
<div class="page-header">
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb mb-2">
            <li class="breadcrumb-item"><a href="{{ url_for('production.index') }}">√úretim Hatlarƒ±</a></li>
            <li class="breadcrumb-item"><a href="{{ url_for('production.view', id=category.id) }}">{{ category.name
                    }}</a></li>
            <li class="breadcrumb-item active">T√ºketim</li>
        </ol>
    </nav>
    <h1 class="page-title">Malzeme T√ºketimi</h1>
    <p class="page-subtitle">{{ category.name }} i√ßin malzeme t√ºketimi kaydedin</p>
</div>

<div class="row">
    <div class="col-lg-8">
        <div class="card">
            <div class="card-body">
                <form method="POST">
                    <div class="row g-3">
                        <div class="col-12">
                            <label class="form-label">√úr√ºn * <small class="text-muted">(T√ºm √ºr√ºnlerden se√ßebilirsiniz -
                                    Ortak malzemeler dahil)</small></label>
                            <div class="position-relative">
                                <input type="text" class="form-control mb-2" id="productSearch"
                                    placeholder="üîç √úr√ºn ara... (kod veya isim yazƒ±n)" autocomplete="off">
                                <select name="product_id" class="form-select" id="productSelect" required
                                    style="display:none;">
                                    <option value="">√úr√ºn Se√ßin</option>
                                    {% for p in products %}
                                    <option value="{{ p.id }}" data-unit="{{ p.unit_type }}"
                                        data-stock="{{ p.current_stock }}" data-code="{{ p.code }}"
                                        data-name="{{ p.name }}"
                                        data-category="{{ p.category.name if p.category else '' }}">
                                        {{ p.code }} - {{ p.name }} (Stok: {{ p.current_stock }} {{ p.unit_type }})
                                    </option>
                                    {% endfor %}
                                </select>
                                <div id="searchResults" class="list-group position-absolute w-100"
                                    style="z-index:1000; max-height:300px; overflow-y:auto; display:none; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
                                </div>
                            </div>
                            <div id="selectedProduct" class="alert alert-warning mt-2" style="display:none;">
                                <strong id="selectedProductName"></strong>
                                <button type="button" class="btn-close float-end" onclick="clearSelection()"></button>
                            </div>
                        </div>

                        <div class="col-md-6">
                            <label class="form-label">T√ºketim Miktarƒ± *</label>
                            <div class="input-group">
                                <input type="number" name="quantity" class="form-control" id="quantityInput" step="0.01"
                                    min="0.01" required>
                                <span class="input-group-text" id="unitDisplay">birim</span>
                            </div>
                            <div class="form-text text-danger" id="stockWarning" style="display: none;">
                                <i class="bi bi-exclamation-triangle me-1"></i>Yetersiz stok!
                            </div>
                        </div>

                        <div class="col-12">
                            <label class="form-label">Notlar</label>
                            <textarea name="notes" class="form-control" rows="2"
                                placeholder="ƒ∞≈ü emri, par√ßa numarasƒ± vb."></textarea>
                        </div>
                    </div>

                    <hr class="my-4">

                    <div class="d-flex gap-2">
                        <button type="submit" class="btn btn-danger" id="submitBtn">
                            <i class="bi bi-dash-lg me-2"></i>T√ºketimi Kaydet (Stoktan D√º≈ü)
                        </button>
                        <a href="{{ url_for('production.view', id=category.id) }}"
                            class="btn btn-outline-secondary">ƒ∞ptal</a>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div class="col-lg-4">
        <div class="card bg-danger bg-opacity-10">
            <div class="card-body text-center">
                <i class="bi bi-gear-wide-connected fs-1 text-danger mb-2"></i>
                <h5>{{ category.name }}</h5>
                <p class="text-muted small mb-0">
                    Se√ßtiƒüiniz malzeme <strong>genel stoktan</strong> d√º≈ü√ºlecektir
                </p>
            </div>
        </div>

        <div class="card mt-3" id="productInfo" style="display: none;">
            <div class="card-body">
                <h6 class="card-title">Se√ßili √úr√ºn</h6>
                <div class="text-center py-3">
                    <div class="display-6 fw-bold" id="currentStock">0</div>
                    <small class="text-muted">Mevcut Stok</small>
                </div>
                <div class="text-center">
                    <small class="text-muted" id="productCategory"></small>
                </div>
            </div>
        </div>

        <div class="card mt-3 bg-info bg-opacity-10">
            <div class="card-body">
                <h6 class="card-title"><i class="bi bi-info-circle me-2"></i>Bilgi</h6>
                <p class="small mb-0">
                    Burada <strong>t√ºm √ºr√ºnler</strong> arasƒ±ndan se√ßim yapabilirsiniz.
                    Ortak malzemeler (somun, civata vb.) dahil t√ºm √ºr√ºnlerin stoku
                    bu sayfadan d√º≈ü√ºr√ºlebilir.
                </p>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    let currentStock = 0;
    const productSelect = document.getElementById('productSelect');
    const searchInput = document.getElementById('productSearch');
    const searchResults = document.getElementById('searchResults');
    const selectedProductDiv = document.getElementById('selectedProduct');
    const selectedProductName = document.getElementById('selectedProductName');

    // T√ºm √ºr√ºn se√ßeneklerini diziye al
    const allProducts = [];
    for (let option of productSelect.options) {
        if (option.value) {
            allProducts.push({
                id: option.value,
                code: option.dataset.code || '',
                name: option.dataset.name || '',
                unit: option.dataset.unit || 'birim',
                stock: parseFloat(option.dataset.stock) || 0,
                category: option.dataset.category || '',
                text: option.textContent
            });
        }
    }

    // Arama fonksiyonu
    searchInput.addEventListener('input', function () {
        const query = this.value.toLowerCase().trim();

        if (query.length < 2) {
            searchResults.style.display = 'none';
            return;
        }

        const filtered = allProducts.filter(p =>
            p.code.toLowerCase().includes(query) ||
            p.name.toLowerCase().includes(query)
        ).slice(0, 20);

        if (filtered.length === 0) {
            searchResults.innerHTML = '<div class="list-group-item text-muted">Sonu√ß bulunamadƒ±</div>';
        } else {
            searchResults.innerHTML = filtered.map(p => {
                const stockClass = p.stock <= 0 ? 'bg-danger' : 'bg-success';
                const isOrtak = p.category === 'ORTAK MALZEMELER' ? '<span class="badge bg-info ms-1">Ortak</span>' : '';
                return `
                <button type="button" class="list-group-item list-group-item-action ${p.stock <= 0 ? 'list-group-item-danger' : ''}" 
                    onclick="selectProduct('${p.id}', '${p.code}', '${p.name.replace(/'/g, "\\'")}', '${p.unit}', ${p.stock}, '${p.category.replace(/'/g, "\\'")}')">
                    <strong>${p.code}</strong> - ${p.name} ${isOrtak}
                    <span class="badge ${stockClass} float-end">${p.stock} ${p.unit}</span>
                </button>
            `;
            }).join('');
        }
        searchResults.style.display = 'block';
    });

    // √úr√ºn se√ßme
    function selectProduct(id, code, name, unit, stock, category) {
        productSelect.value = id;
        currentStock = stock;
        searchInput.value = '';
        searchResults.style.display = 'none';

        const categoryBadge = category === 'ORTAK MALZEMELER' ? ' <span class="badge bg-info">Ortak Malzeme</span>' : '';
        selectedProductName.innerHTML = code + ' - ' + name + ' (Stok: ' + stock + ' ' + unit + ')' + categoryBadge;
        selectedProductDiv.style.display = 'block';

        document.getElementById('unitDisplay').textContent = unit;
        document.getElementById('currentStock').textContent = stock + ' ' + unit;
        document.getElementById('productCategory').textContent = 'Kategori: ' + category;
        document.getElementById('productInfo').style.display = 'block';

        checkStock();
    }

    // Se√ßimi temizle
    function clearSelection() {
        productSelect.value = '';
        currentStock = 0;
        selectedProductDiv.style.display = 'none';
        document.getElementById('productInfo').style.display = 'none';
        searchInput.focus();
    }

    // Dƒ±≈üarƒ± tƒ±klayƒ±nca sonu√ßlarƒ± kapat
    document.addEventListener('click', function (e) {
        if (!searchInput.contains(e.target) && !searchResults.contains(e.target)) {
            searchResults.style.display = 'none';
        }
    });

    document.getElementById('quantityInput').addEventListener('input', checkStock);

    function checkStock() {
        const qty = parseFloat(document.getElementById('quantityInput').value) || 0;
        const warning = document.getElementById('stockWarning');
        const btn = document.getElementById('submitBtn');

        if (qty > currentStock) {
            warning.style.display = 'block';
            btn.disabled = true;
        } else {
            warning.style.display = 'none';
            btn.disabled = false;
        }
    }
</script>
{% endblock %}